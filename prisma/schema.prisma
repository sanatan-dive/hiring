generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  name      String?
  imageUrl  String?
  skills    String[] // User's skills (merged from resume + manual)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resumes        Resume[]
  jobPreferences JobPreferences?
  jobMatches     JobMatch[]
  applications   Application[]
  socialLinks    SocialLink[]
  projects       Project[]
  subscription   Subscription?
  bookmarks      Bookmark[]

  @@map("users")
}

model SocialLink {
  id        String   @id @default(cuid())
  userId    String
  platform  String   // github, linkedin, leetcode, portfolio, twitter, etc.
  url       String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform])
  @@map("social_links")
}

model Project {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  url         String?
  techUsed    String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("projects")
}

model Resume {
  id        String   @id @default(cuid())
  userId    String
  fileName  String
  fileUrl   String?
  rawText   String?
  embedding Unsupported("vector(768)")?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  parsedSkills      ParsedSkill[]
  parsedExperiences ParsedExperience[]

  @@map("resumes")
}

model ParsedSkill {
  id        String   @id @default(cuid())
  resumeId  String
  skill     String
  createdAt DateTime @default(now())

  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("parsed_skills")
}

model ParsedExperience {
  id          String   @id @default(cuid())
  resumeId    String
  company     String?
  role        String?
  duration    String?
  description String?
  createdAt   DateTime @default(now())

  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("parsed_experiences")
}

model JobPreferences {
  id              String   @id @default(cuid())
  userId          String   @unique
  desiredRoles    String[]
  experienceLevel String?
  workLocation    String?
  locations       String[]
  salaryMin       Int?
  salaryMax       Int?
  salaryCurrency  String?
  jobType         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("job_preferences")
}

model JobMatch {
  id         String   @id @default(cuid())
  userId     String
  jobId      String
  score      Float?
  status     String   @default("pending") // new, viewed, applied, rejected
  emailedAt  DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@map("job_matches")
}

model Application {
  id        String   @id @default(cuid())
  userId    String
  jobId     String
  status    String   @default("applied")
  appliedAt DateTime @default(now())
  notes     String?
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@map("applications")
}

model Job {
  id          String   @id @default(cuid())
  title       String
  company     String
  location    String?
  salary      String?
  description String?
  url         String   @unique
  source      String   // adzuna, jsearch, scraper
  techStack   String[]
  embedding   Unsupported("vector(768)")?
  scrapedAt   DateTime @default(now())
  
  matches      JobMatch[]
  applications Application[]
  bookmarks    Bookmark[]

  @@map("jobs")
}

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  jobId     String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@map("bookmarks")
}

model Subscription {
  id              String   @id @default(cuid())
  userId          String   @unique
  plan            String   @default("FREE") // FREE, PRO
  stripeCustomerId String?
  razorpayId      String?
  status          String   @default("active")
  expiresAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}
